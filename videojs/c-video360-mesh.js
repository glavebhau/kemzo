/**
 * Note: Component life cycle functions are called in this sequence: init, update, play, tick, pause, remove
 */

function importBufferGeometry(json) {
  const geometry = new THREE.BufferGeometry();

  Object.keys(json.data.attributes).forEach(attributeName => {
    const attribute = json.data.attributes[attributeName];
    geometry.addAttribute(
      attributeName,
      new THREE.BufferAttribute(new window[attribute.type](attribute.array), attribute.itemSize)
    );
  });

  geometry.setIndex(
    new THREE.BufferAttribute(new window[json.data.index.type](json.data.index.array), json.data.index.itemSize)
  );

  return geometry;
}

AFRAME.registerComponent('c-video360-mesh', {
  schema: {
    type: { type: 'string', default: 'skybox', oneOf: ['skybox, wdm'] },
    textureElId: { type: 'string', default: 'video360' }
  },

  update() {
    if (this.data.type === 'wdm') {
      this.setMesh(this.data.type, true);
    } else {
      this.setMesh(this.data.type, false);
    }
  },

  setMesh(meshType, useCanvasTexture) {
    const { textureElId } = this.data;
    const elToUseAsTexture = document.getElementById(textureElId);

    if (useCanvasTexture) {
      this.texture = new THREE.Texture(elToUseAsTexture);
    } else {
      this.texture = new THREE.VideoTexture(elToUseAsTexture);
    }

    this.texture.format = THREE.RGBFormat;
    this.texture.minFilter = THREE.LinearFilter;
    this.texture.magFilter = THREE.LinearFilter;

    let defaultOpacity = this.el.getAttribute('data-opacity');
    if (defaultOpacity === '' || defaultOpacity === undefined) {
      defaultOpacity = 0;
    } else {
      defaultOpacity = parseFloat(defaultOpacity);
    }

    const material = new THREE.MeshBasicMaterial({
      map: this.texture,
      side: THREE.DoubleSide
    });

    const geometry = importBufferGeometry(this.getGeometryJSON(meshType));
    const mesh = new THREE.Mesh(geometry, material);

    this.el.setObject3D('mesh', mesh);
  },

  getGeometryJSON(meshType) {
    if (meshType === 'wdm') {
      return {
        metadata: {
          generator: 'io_three',
          uv: 60,
          position: 60,
          normal: 60,
          version: 3,
          type: 'BufferGeometry'
        },
        data: {
          index: {
            itemSize: 1,
            array: [
              0,
              1,
              2,
              3,
              4,
              5,
              6,
              7,
              8,
              9,
              10,
              11,
              12,
              13,
              14,
              15,
              16,
              17,
              18,
              19,
              20,
              21,
              22,
              23,
              24,
              25,
              26,
              27,
              28,
              29,
              30,
              31,
              32,
              33,
              34,
              35,
              36,
              37,
              38,
              39,
              40,
              41,
              42,
              43,
              44,
              45,
              46,
              47,
              48,
              49,
              50,
              51,
              52,
              53,
              54,
              55,
              56,
              57,
              58,
              59
            ],
            type: 'Uint16Array'
          },
          groups: [
            {
              start: 0,
              materialIndex: 0,
              count: 60
            }
          ],
          attributes: {
            uv: {
              itemSize: 2,
              array: [
                0.5,
                0.10833,
                0.334893,
                0.00278147,
                0.5,
                0.0027815,
                0.748447,
                0.113884,
                0.251586,
                0.997259,
                0.251586,
                0.113884,
                0.331736,
                0.00281028,
                0.168264,
                0.108301,
                0.168264,
                0.00281028,
                0.834958,
                0.00281019,
                0.998375,
                0.108301,
                0.834958,
                0.108301,
                0.00157773,
                0.108315,
                0.165089,
                0.00279647,
                0.165089,
                0.108315,
                0.00149697,
                0.997208,
                0.248503,
                0.113935,
                0.248503,
                0.997208,
                0.998465,
                0.113683,
                0.751643,
                0.997459,
                0.751643,
                0.113683,
                0.749967,
                0.108317,
                0.668257,
                0.108317,
                0.749967,
                0.00279451,
                0.665108,
                0.0027815,
                0.665107,
                0.10833,
                0.5,
                0.10833,
                0.5,
                0.10833,
                0.334893,
                0.10833,
                0.334893,
                0.00278147,
                0.5,
                0.0027815,
                0.665108,
                0.0027815,
                0.5,
                0.10833,
                0.748447,
                0.113884,
                0.748447,
                0.997259,
                0.251586,
                0.997259,
                0.331736,
                0.00281028,
                0.331736,
                0.108301,
                0.168264,
                0.108301,
                0.834958,
                0.00281019,
                0.998375,
                0.00281023,
                0.998375,
                0.108301,
                0.00157773,
                0.108315,
                0.00157773,
                0.00279647,
                0.165089,
                0.00279647,
                0.00149697,
                0.997208,
                0.00149691,
                0.113935,
                0.248503,
                0.113935,
                0.998465,
                0.113683,
                0.998465,
                0.997459,
                0.751643,
                0.997459,
                0.749967,
                0.00279451,
                0.831678,
                0.00279451,
                0.831678,
                0.108317,
                0.831678,
                0.108317,
                0.749967,
                0.108317,
                0.749967,
                0.00279451,
                0.668257,
                0.108317,
                0.668257,
                0.00279451,
                0.749967,
                0.00279451
              ],
              type: 'Float32Array'
            },
            position: {
              itemSize: 3,
              array: [
                7.15256e-7,
                -4,
                -4,
                -4,
                -4,
                4,
                0,
                -4,
                4,
                4,
                -4,
                4,
                4,
                4,
                -4,
                4,
                -4,
                -4,
                -4,
                -4,
                4,
                -2.14577e-6,
                4,
                4,
                0,
                -4,
                4,
                -4,
                -4,
                4,
                -4,
                4,
                -4,
                -4,
                4,
                4,
                -4,
                4,
                -4,
                7.15256e-7,
                -4,
                -4,
                9.53674e-7,
                4,
                -4,
                9.53674e-7,
                4,
                -4,
                4,
                -4,
                -4,
                4,
                4,
                -4,
                0,
                -4,
                4,
                4,
                4,
                4,
                4,
                -4,
                4,
                -2.14577e-6,
                4,
                4,
                -4,
                4,
                4,
                9.53674e-7,
                4,
                -4,
                4,
                -4,
                4,
                4,
                -4,
                -4,
                7.15256e-7,
                -4,
                -4,
                7.15256e-7,
                -4,
                -4,
                -4,
                -4,
                -4,
                -4,
                -4,
                4,
                0,
                -4,
                4,
                4,
                -4,
                4,
                7.15256e-7,
                -4,
                -4,
                4,
                -4,
                4,
                4,
                4,
                4,
                4,
                4,
                -4,
                -4,
                -4,
                4,
                -4,
                4,
                4,
                -2.14577e-6,
                4,
                4,
                -4,
                -4,
                4,
                -4,
                -4,
                -4,
                -4,
                4,
                -4,
                -4,
                4,
                -4,
                -4,
                -4,
                -4,
                7.15256e-7,
                -4,
                -4,
                9.53674e-7,
                4,
                -4,
                7.15256e-7,
                -4,
                -4,
                4,
                -4,
                -4,
                0,
                -4,
                4,
                -2.14577e-6,
                4,
                4,
                4,
                4,
                4,
                9.53674e-7,
                4,
                -4,
                4,
                4,
                -4,
                4,
                4,
                4,
                4,
                4,
                4,
                -2.14577e-6,
                4,
                4,
                9.53674e-7,
                4,
                -4,
                -4,
                4,
                4,
                -4,
                4,
                -4,
                9.53674e-7,
                4,
                -4
              ],
              type: 'Float32Array'
            },
            normal: {
              itemSize: 3,
              array: [
                1.77636e-15,
                1,
                -2.98023e-8,
                1.77636e-15,
                1,
                -2.98023e-8,
                1.77636e-15,
                1,
                -2.98023e-8,
                -1,
                2.38419e-7,
                -1.42109e-14,
                -1,
                2.38419e-7,
                -1.42109e-14,
                -1,
                2.38419e-7,
                -1.42109e-14,
                5.96046e-8,
                8.9407e-8,
                -1,
                5.96046e-8,
                8.9407e-8,
                -1,
                5.96046e-8,
                8.9407e-8,
                -1,
                1,
                1.19209e-7,
                2.08616e-7,
                1,
                1.19209e-7,
                2.08616e-7,
                1,
                1.19209e-7,
                2.08616e-7,
                -1.78814e-7,
                -1.49012e-7,
                1,
                -1.78814e-7,
                -1.49012e-7,
                1,
                -1.78814e-7,
                -1.49012e-7,
                1,
                -2.98023e-7,
                -1.78814e-7,
                1,
                -2.98023e-7,
                -1.78814e-7,
                1,
                -2.98023e-7,
                -1.78814e-7,
                1,
                5.96046e-8,
                2.98023e-7,
                -1,
                5.96046e-8,
                2.98023e-7,
                -1,
                5.96046e-8,
                2.98023e-7,
                -1,
                -1.59872e-14,
                -1,
                2.98023e-8,
                -1.59872e-14,
                -1,
                2.98023e-8,
                -1.59872e-14,
                -1,
                2.98023e-8,
                7.10543e-15,
                1,
                -2.98023e-8,
                7.10543e-15,
                1,
                -2.98023e-8,
                7.10543e-15,
                1,
                -2.98023e-8,
                7.10543e-15,
                1,
                -2.98023e-8,
                7.10543e-15,
                1,
                -2.98023e-8,
                7.10543e-15,
                1,
                -2.98023e-8,
                1.77636e-15,
                1,
                -2.98023e-8,
                1.77636e-15,
                1,
                -2.98023e-8,
                1.77636e-15,
                1,
                -2.98023e-8,
                -1,
                -3.27825e-7,
                -5.66244e-7,
                -1,
                -3.27825e-7,
                -5.66244e-7,
                -1,
                -3.27825e-7,
                -5.66244e-7,
                5.36442e-7,
                -1.49012e-7,
                -1,
                5.36442e-7,
                -1.49012e-7,
                -1,
                5.36442e-7,
                -1.49012e-7,
                -1,
                1,
                1.49012e-7,
                2.38419e-7,
                1,
                1.49012e-7,
                2.38419e-7,
                1,
                1.49012e-7,
                2.38419e-7,
                -2.38419e-7,
                -1.78814e-7,
                1,
                -2.38419e-7,
                -1.78814e-7,
                1,
                -2.38419e-7,
                -1.78814e-7,
                1,
                -2.38419e-7,
                -1.49012e-7,
                1,
                -2.38419e-7,
                -1.49012e-7,
                1,
                -2.38419e-7,
                -1.49012e-7,
                1,
                4.76837e-7,
                8.94071e-8,
                -1,
                4.76837e-7,
                8.94071e-8,
                -1,
                4.76837e-7,
                8.94071e-8,
                -1,
                -8.88178e-15,
                -1,
                2.98023e-8,
                -8.88178e-15,
                -1,
                2.98023e-8,
                -8.88178e-15,
                -1,
                2.98023e-8,
                -1.42109e-14,
                -1,
                2.98023e-8,
                -1.42109e-14,
                -1,
                2.98023e-8,
                -1.42109e-14,
                -1,
                2.98023e-8,
                -5.32907e-15,
                -1,
                2.98023e-8,
                -5.32907e-15,
                -1,
                2.98023e-8,
                -5.32907e-15,
                -1,
                2.98023e-8
              ],
              type: 'Float32Array'
            }
          }
        }
      };
    } else if (meshType === 'skybox') {
      return {
        metadata: {
          generator: 'io_three',
          normal: 36,
          position: 36,
          type: 'BufferGeometry',
          uv: 36,
          version: 3
        },
        data: {
          groups: [
            {
              materialIndex: 0,
              count: 36,
              start: 0
            }
          ],
          index: {
            array: [
              0,
              1,
              2,
              3,
              4,
              5,
              6,
              7,
              8,
              9,
              10,
              11,
              12,
              13,
              14,
              15,
              16,
              17,
              18,
              19,
              20,
              21,
              22,
              23,
              24,
              25,
              26,
              27,
              28,
              29,
              30,
              31,
              32,
              33,
              34,
              35
            ],
            type: 'Uint16Array',
            itemSize: 1
          },
          attributes: {
            uv: {
              array: [
                0.998993,
                0.498489,
                0.667695,
                0.00154229,
                0.998993,
                0.0015422,
                0.00105935,
                0.00161472,
                0.332357,
                0.498562,
                0.00105923,
                0.498562,
                0.66564,
                0.501553,
                0.334341,
                0.9985,
                0.334341,
                0.501553,
                0.999014,
                0.501584,
                0.667716,
                0.998532,
                0.667715,
                0.501584,
                0.665745,
                0.00161488,
                0.334447,
                0.498562,
                0.334447,
                0.00161487,
                0.00117854,
                0.998523,
                0.332477,
                0.501575,
                0.332477,
                0.998523,
                0.998993,
                0.498489,
                0.667695,
                0.49849,
                0.667695,
                0.00154229,
                0.00105935,
                0.00161472,
                0.332358,
                0.00161499,
                0.332357,
                0.498562,
                0.66564,
                0.501553,
                0.66564,
                0.9985,
                0.334341,
                0.9985,
                0.999014,
                0.501584,
                0.999014,
                0.998532,
                0.667716,
                0.998532,
                0.665745,
                0.00161488,
                0.665745,
                0.498562,
                0.334447,
                0.498562,
                0.00117854,
                0.998523,
                0.0011787,
                0.501575,
                0.332477,
                0.501575
              ],
              type: 'Float32Array',
              itemSize: 2
            },
            normal: {
              array: [
                1.77636e-15,
                1,
                -2.98023e-8,
                1.77636e-15,
                1,
                -2.98023e-8,
                1.77636e-15,
                1,
                -2.98023e-8,
                -7.10543e-15,
                -1,
                2.98023e-8,
                -7.10543e-15,
                -1,
                2.98023e-8,
                -7.10543e-15,
                -1,
                2.98023e-8,
                -1,
                2.38419e-7,
                -1.42109e-14,
                -1,
                2.38419e-7,
                -1.42109e-14,
                -1,
                2.38419e-7,
                -1.42109e-14,
                5.96046e-8,
                2.98023e-7,
                -1,
                5.96046e-8,
                2.98023e-7,
                -1,
                5.96046e-8,
                2.98023e-7,
                -1,
                1,
                1.19209e-7,
                2.08616e-7,
                1,
                1.19209e-7,
                2.08616e-7,
                1,
                1.19209e-7,
                2.08616e-7,
                -2.38419e-7,
                -1.78814e-7,
                1,
                -2.38419e-7,
                -1.78814e-7,
                1,
                -2.38419e-7,
                -1.78814e-7,
                1,
                7.10543e-15,
                1,
                -2.98023e-8,
                7.10543e-15,
                1,
                -2.98023e-8,
                7.10543e-15,
                1,
                -2.98023e-8,
                -1.5099e-14,
                -1,
                2.98023e-8,
                -1.5099e-14,
                -1,
                2.98023e-8,
                -1.5099e-14,
                -1,
                2.98023e-8,
                -1,
                -3.27825e-7,
                -5.66244e-7,
                -1,
                -3.27825e-7,
                -5.66244e-7,
                -1,
                -3.27825e-7,
                -5.66244e-7,
                5.0664e-7,
                -1.49012e-7,
                -1,
                5.0664e-7,
                -1.49012e-7,
                -1,
                5.0664e-7,
                -1.49012e-7,
                -1,
                1,
                1.49012e-7,
                2.38419e-7,
                1,
                1.49012e-7,
                2.38419e-7,
                1,
                1.49012e-7,
                2.38419e-7,
                -2.38419e-7,
                -1.78814e-7,
                1,
                -2.38419e-7,
                -1.78814e-7,
                1,
                -2.38419e-7,
                -1.78814e-7,
                1
              ],
              type: 'Float32Array',
              itemSize: 3
            },
            position: {
              array: [
                1,
                -1,
                -1,
                -1,
                -1,
                1,
                1,
                -1,
                1,
                0.999999,
                1,
                1,
                -1,
                1,
                -1,
                1,
                1,
                -1,
                1,
                -1,
                1,
                1,
                1,
                -1,
                1,
                -1,
                -1,
                -1,
                -1,
                1,
                0.999999,
                1,
                1,
                1,
                -1,
                1,
                -1,
                -1,
                1,
                -1,
                1,
                -1,
                -1,
                1,
                1,
                -1,
                1,
                -1,
                1,
                -1,
                -1,
                1,
                1,
                -1,
                1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                -1,
                1,
                0.999999,
                1,
                1,
                -1,
                1,
                1,
                -1,
                1,
                -1,
                1,
                -1,
                1,
                0.999999,
                1,
                1,
                1,
                1,
                -1,
                -1,
                -1,
                1,
                -1,
                1,
                1,
                0.999999,
                1,
                1,
                -1,
                -1,
                1,
                -1,
                -1,
                -1,
                -1,
                1,
                -1,
                -1,
                1,
                -1,
                -1,
                -1,
                -1,
                1,
                -1,
                -1
              ],
              type: 'Float32Array',
              itemSize: 3
            }
          }
        }
      };
    }
    return null;
  }
});
